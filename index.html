<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>fullofcoins</title>
        <link rel="icon" href="favicon.png" type="image/png" />
        <link rel="stylesheet" href="style.css?v=1.6" />
    </head>
    <body>
        <div class="layout-wrapper">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <h2>fullofcoins</h2>
                <ul>
                    <li>üè† Home</li>
                    <li>üìü Explore</li>
                    <li>üë§ Profile</li>
                    <li><button id="connectBtn">Connect Wallet</button></li>
                </ul>
                <div id="walletAddress" class="wallet-address"></div>
            </div>

            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- Main Feed -->
            <div class="main-feed">
                <div class="feed-header">
                    <button id="menu-toggle-btn" class="menu-toggle">‚ò∞</button>
                    <h2>Decentralized Tweets</h2>
                    <button id="right-panel-toggle-btn" class="menu-toggle">
                        ‚ãÆ
                    </button>
                </div>

                <!-- New Posts Banner -->
                <div id="newPostsBanner" style="display: none">
                    <button id="showNewPostsBtn">Show new posts</button>
                </div>

                <!-- Tweet Composer -->
                <div id="tweetComposer" class="tweet-composer">
                    <textarea
                        id="tweetInput"
                        rows="3"
                        placeholder="What's happening?"
                    ></textarea>

                    <!-- NEW: Image Preview Area -->
                    <div
                        id="imagePreviewContainer"
                        class="image-preview-container"
                        style="display: none"
                    >
                        <button id="removeImageBtn" class="remove-image-btn">
                            √ó
                        </button>
                        <img id="imagePreview" src="#" alt="Image preview" />
                    </div>

                    <!-- Hidden file input -->
                    <input
                        type="file"
                        id="imageInput"
                        accept="image/jpeg,image/png"
                        style="display: none"
                    />
                    <div class="composer-actions">
                        <!-- NEW: Attach Image Button -->
                        <button
                            id="attachImageBtn"
                            class="attach-btn"
                            title="Attach image"
                        >
                            üñºÔ∏è
                        </button>

                        <button id="postTweetBtn">Tweet</button>
                    </div>

                    <div id="tweetMessage" class="tweet-message"></div>
                </div>
                <div id="tweetList"><!-- Tweets will go here --></div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel" id="right-panel">
                <h3>Coming Soon</h3>
                <p>Analytics, Suggestions, or Ads</p>
            </div>
        </div>

        <!-- Wallet Modal -->
        <div id="walletModal" class="modal">
            <div class="modal-content">
                <h3>Connect Wallet</h3>
                <button id="metamaskBtn">ü¶Ñ Connect with MetaMask</button>
                <button id="closeModal" class="close-btn">Cancel</button>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <!-- Scripts -->
        <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>

        <script>
            // This makes the full ABI available to all other scripts.
            window.fullTweetContractAbi = [
                {
                    anonymous: false,
                    inputs: [
                        {
                            indexed: true,
                            internalType: 'uint256',
                            name: 'tweetId',
                            type: 'uint256',
                        },
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'user',
                            type: 'address',
                        },
                    ],
                    name: 'TweetLiked',
                    type: 'event',
                },
                {
                    anonymous: false,
                    inputs: [
                        {
                            indexed: false,
                            internalType: 'uint256',
                            name: 'id',
                            type: 'uint256',
                        },
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'author',
                            type: 'address',
                        },
                        {
                            indexed: false,
                            internalType: 'string',
                            name: 'content',
                            type: 'string',
                        },
                        {
                            indexed: false,
                            internalType: 'string',
                            name: 'imageCid',
                            type: 'string',
                        },
                        {
                            indexed: false,
                            internalType: 'uint256',
                            name: 'timestamp',
                            type: 'uint256',
                        },
                        {
                            indexed: false,
                            internalType: 'uint256',
                            name: 'chainId',
                            type: 'uint256',
                        },
                    ],
                    name: 'TweetPosted',
                    type: 'event',
                },
                {
                    anonymous: false,
                    inputs: [
                        {
                            indexed: true,
                            internalType: 'uint256',
                            name: 'tweetId',
                            type: 'uint256',
                        },
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'user',
                            type: 'address',
                        },
                    ],
                    name: 'TweetUnliked',
                    type: 'event',
                },
                {
                    anonymous: false,
                    inputs: [
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'follower',
                            type: 'address',
                        },
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'followed',
                            type: 'address',
                        },
                    ],
                    name: 'UserFollowed',
                    type: 'event',
                },
                {
                    anonymous: false,
                    inputs: [
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'follower',
                            type: 'address',
                        },
                        {
                            indexed: true,
                            internalType: 'address',
                            name: 'followed',
                            type: 'address',
                        },
                    ],
                    name: 'UserUnfollowed',
                    type: 'event',
                },
                {
                    inputs: [],
                    name: 'COOLDOWN_TIME',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        {
                            internalType: 'address',
                            name: '_userToFollow',
                            type: 'address',
                        },
                    ],
                    name: 'follow',
                    outputs: [],
                    stateMutability: 'nonpayable',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'address', name: '', type: 'address' },
                    ],
                    name: 'followerCount',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'address', name: '', type: 'address' },
                    ],
                    name: 'followingCount',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'address', name: '', type: 'address' },
                        { internalType: 'address', name: '', type: 'address' },
                    ],
                    name: 'isFollowing',
                    outputs: [{ internalType: 'bool', name: '', type: 'bool' }],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'address', name: '', type: 'address' },
                    ],
                    name: 'lastPostTime',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        {
                            internalType: 'uint256',
                            name: '_tweetId',
                            type: 'uint256',
                        },
                    ],
                    name: 'likeTweet',
                    outputs: [],
                    stateMutability: 'nonpayable',
                    type: 'function',
                },
                {
                    inputs: [],
                    name: 'nextTweetId',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        {
                            internalType: 'string',
                            name: '_content',
                            type: 'string',
                        },
                        {
                            internalType: 'string',
                            name: '_imageCid',
                            type: 'string',
                        },
                    ],
                    name: 'postTweet',
                    outputs: [],
                    stateMutability: 'nonpayable',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    name: 'tweetLikeCount',
                    outputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                    ],
                    stateMutability: 'view',
                    type: 'function',
                },
                {
                    inputs: [
                        {
                            internalType: 'address',
                            name: '_userToUnfollow',
                            type: 'address',
                        },
                    ],
                    name: 'unfollow',
                    outputs: [],
                    stateMutability: 'nonpayable',
                    type: 'function',
                },
                {
                    inputs: [
                        {
                            internalType: 'uint256',
                            name: '_tweetId',
                            type: 'uint256',
                        },
                    ],
                    name: 'unlikeTweet',
                    outputs: [],
                    stateMutability: 'nonpayable',
                    type: 'function',
                },
                {
                    inputs: [
                        { internalType: 'uint256', name: '', type: 'uint256' },
                        { internalType: 'address', name: '', type: 'address' },
                    ],
                    name: 'userHasLiked',
                    outputs: [{ internalType: 'bool', name: '', type: 'bool' }],
                    stateMutability: 'view',
                    type: 'function',
                },
            ]
        </script>

        <script src="app.js?v=1.6"></script>
        <script src="tweetPost.js?v=1.6"></script>
        <script src="tweetFetcher.js?v=1.6"></script>
        <script src="like.js?v=1.6"></script>

        <script>
            window.chains = [
                {
                    name: 'Sepolia',
                    rpcUrl: 'https://ethereum-sepolia.publicnode.com',
                    contractAddress:
                        '0xba04E4e376862A98B7B2175107ebc438aC032b25',
                    startBlock: 8594107,
                    chainId: 11155111,
                },
            ]
            window.addEventListener('DOMContentLoaded', () => {
                const ready = setInterval(() => {
                    if (window.tweetFetcher && window.ethers) {
                        clearInterval(ready)

                        const leftToggleBtn =
                            document.getElementById('menu-toggle-btn')
                        const rightToggleBtn = document.getElementById(
                            'right-panel-toggle-btn'
                        )
                        const leftPanel = document.getElementById('sidebar')
                        const rightPanel =
                            document.getElementById('right-panel')
                        const overlay =
                            document.getElementById('sidebar-overlay')
                        const walletModal =
                            document.getElementById('walletModal')
                        const connectBtn = document.getElementById('connectBtn')
                        const closeModal = document.getElementById('closeModal')

                        function closeAllPanels() {
                            leftPanel.classList.remove('is-open')
                            rightPanel.classList.remove('is-open')
                            document.body.classList.remove('menu-is-open')
                        }

                        if (leftToggleBtn) {
                            leftToggleBtn.addEventListener('click', e => {
                                e.stopPropagation()
                                const isOpen =
                                    leftPanel.classList.contains('is-open')
                                closeAllPanels()
                                if (!isOpen) {
                                    leftPanel.classList.add('is-open')
                                    document.body.classList.add('menu-is-open')
                                }
                            })
                        }

                        if (rightToggleBtn) {
                            rightToggleBtn.addEventListener('click', e => {
                                e.stopPropagation()
                                const isOpen =
                                    rightPanel.classList.contains('is-open')
                                closeAllPanels()
                                if (!isOpen) {
                                    rightPanel.classList.add('is-open')
                                    document.body.classList.add('menu-is-open')
                                }
                            })
                        }

                        if (overlay) {
                            overlay.addEventListener('click', closeAllPanels)
                        }

                        tweetFetcher.init()
                        tweetFetcher.loadCachedTweets()
                        ;(async () => {
                            await tweetFetcher.fetchAndUpdateTweets(
                                window.chains
                            )
                        })()

                        setInterval(
                            () =>
                                tweetFetcher.fetchAndUpdateTweets(
                                    window.chains
                                ),
                            60000
                        )
                    }
                }, 100)
            })
        </script>
    </body>
</html>
